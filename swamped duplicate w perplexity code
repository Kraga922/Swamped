import streamlit as st
import pandas as pd
import plotly.express as px
import datetime
import folium
from streamlit_folium import st_folium

# Initialize session state for storing data
if 'drink_logs' not in st.session_state:
    st.session_state['drink_logs'] = []

if 'groups' not in st.session_state:
    st.session_state['groups'] = {}

if 'locations' not in st.session_state:
    st.session_state['locations'] = []

# Sidebar for Navigation
st.sidebar.title("Navigation")
page = st.sidebar.radio("Go to:", ["Home", "Log Drinks", "Groups", "Dashboard", "Location Sharing"])

# Home Page
if page == "Home":
    st.title("Welcome to the Drink Tracker App")
    st.write("This app helps you log your drinks, share locations, and manage groups to keep track of drinking habits.")
    st.write("Features:")
    st.write("- Log your drinks and view drink history.")
    st.write("- Create and join groups to track drinks together.")
    st.write("- Share your location with group members in real-time.")
    st.write("- View insightful dashboards and trends.")

# Log Drinks Page
elif page == "Log Drinks":
    st.title("Log Your Drinks")

    with st.form("drink_log_form"):
        drink_type = st.selectbox("Select Drink Type:", ["Beer", "Wine", "Cocktail", "Other"])
        quantity = st.number_input("Quantity (in standard drinks):", min_value=0.0, step=0.1)
        timestamp = st.date_input("Date:", datetime.date.today())
        submit = st.form_submit_button("Log Drink")

        if submit:
            st.session_state['drink_logs'].append({
                "type": drink_type,
                "quantity": quantity,
                "timestamp": timestamp
            })
            st.success("Drink logged successfully!")

    st.write("### Your Drink Logs")
    if st.session_state['drink_logs']:
        logs_df = pd.DataFrame(st.session_state['drink_logs'])
        st.dataframe(logs_df)
    else:
        st.write("No drinks logged yet.")

# Groups Page
elif page == "Groups":
    st.title("Manage Groups")

    # Create or Join a Group
    with st.form("group_form"):
        group_name = st.text_input("Group Name:")
        action = st.radio("Action:", ["Create Group", "Join Group"])
        submit_group = st.form_submit_button("Submit")

        if submit_group:
            if action == "Create Group":
                if group_name not in st.session_state['groups']:
                    st.session_state['groups'][group_name] = []
                    st.success(f"Group '{group_name}' created successfully!")
                else:
                    st.error("Group already exists!")
            elif action == "Join Group":
                if group_name in st.session_state['groups']:
                    st.success(f"Joined group '{group_name}' successfully!")
                else:
                    st.error("Group does not exist!")

    st.write("### Your Groups")
    if st.session_state['groups']:
        for group, members in st.session_state['groups'].items():
            st.write(f"- {group}")
    else:
        st.write("You are not part of any groups yet.")

    # Log Drinks for Group Members
    st.write("### Log Drinks for Group Members")
    selected_group = st.selectbox("Select Group:", list(st.session_state['groups'].keys()))
    if selected_group:
        with st.form("group_drink_log_form"):
            member_name = st.text_input("Member Name:")
            drink_type = st.selectbox("Select Drink Type:", ["Beer", "Wine", "Cocktail", "Other"])
            quantity = st.number_input("Quantity (in standard drinks):", min_value=0.0, step=0.1)
            timestamp = st.date_input("Date:", datetime.date.today())
            submit_member_log = st.form_submit_button("Log Drink for Member")

            if submit_member_log:
                st.session_state['groups'][selected_group].append({
                    "member": member_name,
                    "type": drink_type,
                    "quantity": quantity,
                    "timestamp": timestamp
                })
                st.success(f"Logged drink for {member_name} in group '{selected_group}'")

# Dashboard Page
elif page == "Dashboard":
    st.title("Your Dashboard")

    if st.session_state['drink_logs']:
        logs_df = pd.DataFrame(st.session_state['drink_logs'])

        # Summary Stats
        total_drinks = logs_df['quantity'].sum()
        st.write(f"### Total Drinks Logged: {total_drinks}")

        # Drinks Over Time
        logs_df['timestamp'] = pd.to_datetime(logs_df['timestamp'])
        daily_summary = logs_df.groupby('timestamp')['quantity'].sum().reset_index()
        fig = px.line(daily_summary, x='timestamp', y='quantity', title="Drinks Over Time")
        st.plotly_chart(fig)
    else:
        st.write("No drink logs available to display.")

# Location Sharing Page
elif page == "Location Sharing":
    st.title("Location Sharing")

    with st.form("location_form"):
        latitude = st.number_input("Enter Latitude:", format="%.6f")
        longitude = st.number_input("Enter Longitude:", format="%.6f")
        submit_location = st.form_submit_button("Share Location")

        if submit_location:
            st.session_state['locations'].append({
                "latitude": latitude,
                "longitude": longitude
            })
            st.success("Location shared successfully!")

    st.write("### Shared Locations")
    if st.session_state['locations']:
        m = folium.Map(location=[0, 0], zoom_start=2)
        for loc in st.session_state['locations']:
            folium.Marker([loc['latitude'], loc['longitude']]).add_to(m)
        st_folium(m, width=700, height=500)
    else:
        st.write("No locations shared yet.")

//perplexity code
import streamlit as st
import datetime
import pandas as pd
from PIL import Image
import plotly.express as px

def initialize_session_state():
    if 'drink_count' not in st.session_state:
        st.session_state.drink_count = 0
    if 'drinks_log' not in st.session_state:
        st.session_state.drinks_log = []
    if 'current_group' not in st.session_state:
        st.session_state.current_group = None
    if 'is_admin' not in st.session_state:
        st.session_state.is_admin = True

def calculate_bac(drinks, time_elapsed, weight, gender):
    # Simplified BAC calculation
    alcohol_grams = drinks * 14  # Assuming standard drink = 14g alcohol
    if gender.lower() == 'male':
        r = 0.68
    else:
        r = 0.55
    bac = (alcohol_grams * 5.14 / (weight * r)) - (0.015 * time_elapsed)
    return max(0, bac)

def main():
    st.set_page_config(page_title="Swamped - Alcohol Tracker", layout="wide")
    initialize_session_state()

    # Sidebar navigation
    st.sidebar.title("Navigation")
    page = st.sidebar.radio("Go to", ["Current Night", "Groups", "Settings", "Life Expectancy"])

    if page == "Current Night":
        display_current_night()
    elif page == "Groups":
        display_groups()
    elif page == "Settings":
        display_settings()
    elif page == "Life Expectancy":
        display_life_expectancy()

def display_current_night():
    st.title("Current Night")
    
    col1, col2, col3 = st.columns([2,1,1])
    
    with col1:
        if not st.session_state.current_group:
            if st.button("Start Night"):
                st.session_state.current_group = "Solo"
                st.rerun()
        else:
            st.header(f"Group: {st.session_state.current_group}")
            
            # Drink counter and add drink button
            col_count, col_add = st.columns([2,1])
            with col_count:
                st.subheader(f"Total Drinks: {st.session_state.drink_count}")
            with col_add:
                if st.button("Add Drink"):
                    drink_type = st.selectbox("Select drink type:", 
                                            ["Beer", "Wine", "Cocktail", "Shot"])
                    if st.button("Confirm"):
                        st.session_state.drink_count += 1
                        st.session_state.drinks_log.append({
                            'timestamp': datetime.datetime.now(),
                            'drink_type': drink_type,
                            'location': "Current Location"
                        })
                        st.rerun()

    with col2:
        st.subheader("Drink Breakdown")
        if st.session_state.drinks_log:
            drink_df = pd.DataFrame(st.session_state.drinks_log)
            drink_counts = drink_df['drink_type'].value_counts()
            fig = px.pie(values=drink_counts.values, 
                        names=drink_counts.index, 
                        title="Drinks by Type")
            st.plotly_chart(fig)

    with col3:
        st.subheader("Safety Features")
        bac = calculate_bac(st.session_state.drink_count, 1, 70, 'male')
        st.metric("Estimated BAC", f"{bac:.3f}")
        
        if bac >= 0.08:
            st.warning("BAC above legal limit!")
            if st.button("Call Uber"):
                st.success("Uber request initiated!")

def display_groups():
    st.title("Groups")
    if st.button("Create New Group"):
        group_name = st.text_input("Group Name")
        if st.button("Confirm Group"):
            st.success(f"Group {group_name} created!")

def display_settings():
    st.title("Settings")
    uber_threshold = st.slider("Call Uber at BAC:", 0.0, 0.15, 0.08)
    enable_notifications = st.toggle("Enable Notifications")
    st.button("Save Settings")

def display_life_expectancy():
    st.title("Life Expectancy Impact")
    total_drinks = st.session_state.drink_count
    st.metric("Lifetime Drinks", total_drinks)
    # Simplified calculation
    years_impact = total_drinks * 0.0001
    st.metric("Estimated Impact on Life Expectancy", f"-{years_impact:.2f} years")

if __name__ == "__main__":
    main()
